---
layout: post
title: "来做一个卡牌引擎吧"
date: 2025-10-19 11:00:00 +0800
categories: blog
---

总之想试试能不能写一个泛用的卡牌引擎，至少能实现游戏王的一些重要特点吧。先记录一下能预见到的问题和挑战。

作为参考我们有ygocore作为核心，MDPro3作为前端。

# 从自然语言到程序语言

卡牌引擎重要的一点自然是从自然语言到程序语言的映射。ygocore以lua为基础，提供了编写卡牌效果所需要的接口和描述一张卡片的数据格式。如果自己来写的话，自然也是从宿主语言开始，不过也许能做出一些更接近自然语言的dsl也说不定？

另外，也希望能将效果本身作为first-class对象进行操作，除了普通的替代式效应、复制效果之外，能更普遍的对效果进行修改也许会变得更有趣？

# 我能发动吗？我能处理吗？

万智牌和游戏王都有发动卡片时的特殊规则，比如法术力异能和cost必须严格支付。[喀勒克族制铁厂](https://scryfall.com/card/5dn/134)组合技利用法术力异能不进入堆叠、在支付费用之前可以多次启动法术力异能的规则让极端情况下坟场中不需要4c以上神器（用来回收制铁厂）就能达成loop。而游戏王cost必须严格支付的规则导致某些处理在电子卡牌中仍然无法完全实现，比如复数技能抽取+仙仙下禁忌的一滴的cost选取，在ygocore和官方的md中仍有bug。

可以发现，这些操作最大的特点就是在发动卡牌这个微妙的时点内，和正常处理不同，有些操作不应该立即产生副作用（制铁厂牺牲回收密耳和制铁厂牺牲自己的后续触发应当同时处理），有些又应该立即产生副作用（一滴尝试送墓技能抽取的瞬间，仙仙的永续效果立即适用，技能抽取将会除外，于是技能抽取不能作为cost送去墓地，如果是复数技能抽取，则是必须保留一张）。

另外游戏王还有着不能空发的限制，“想象中”效果必须能被完整处理完，而处理则是处理到不能处理位置。某种意义上可以理解成“代码”首先被一行一行的单独验证是否可以被执行（不考虑前面的“代码”的副作用），然后再被真正的顺序执行到出错为止。

这里可以看出，描述cost的代码和描述效果的代码本身就蕴含了是否能发动、处理的信息，但是由于规则的复杂性，ygocore是手动判断能否发动效果的判断的。

也许能通过类似prolog的推理/搜索方式来以代码来推断是否能发动/处理？

# 谁可以操作？

即使不考虑有两个玩家轮流获得优先权，引擎本身也需要等待玩家输入来更新状态，效果处理中也需要玩家来选择对象，单人游戏固然可以直接做进UI，但是耦合度太高也不够通用。ygocore的实现是将引擎的主循环做成一个大协程，等待玩家输入的时候相当于yield出去，而yield的返回值恰好能用来区分期待的用户输入类型（动作/效果处理的选择等），无论用户的输入是本地UI传入还是通过网络同步过来，都通过lua_resume传回主循环，这样引擎本身也不需要关心用户是如何输入操作。

不过如果想使用C#作为宿主语言的话，还需要改造一下协程（虽然说是协程不过只是利用IEnumerator的特性模拟协程的行为罢了），因为C#的MoveNext并不能传回参数。